
            <!DOCTYPE html>
            <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>
 Media Player Classic - HC 源代码分析 3：核心类 （CMainFrame）（2） - CSDN博客
</title>

                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/detail-60a2c245da.min.css">
                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/themes/skin3-template/skin3-template-88717cedf2.min.css">

                <script type="text/javascript">
                var username = "";
                </script>

                <script src="https://csdnimg.cn/public/common/libs/jquery/jquery-1.9.1.min.js" type="text/javascript"></script>

                <!-- 新版上报 -->
                <!-- 新版上报end -->
                <link rel="stylesheet" href="https://csdnimg.cn/public/sandalstrap/1.3/css/sandalstrap.min.css"> 
                </head>
                <body>    
        
                    <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/blog_code-c3a0c33d5c.css">
                    <div class="container clearfix pt0" id="mainBox">
        <main style="width: 100%;"><div class="blog-content-box">
 <div class="article-title-box" id="article_anchors_307">
  <span class="article-type type-1 float-left">
   原
  </span>
  <h1 class="title-article">
   Media Player Classic - HC 源代码分析 3：核心类 （CMainFrame）（2）
  </h1>
 </div>
 <div class="article-info-box">
  <div class="article-bar-top d-flex">
   <span class="time">
    2013年10月28日 23:52:56
   </span>
   <div ">
    <span class="read-count">
     阅读数：5853
    </span>
   </div>
  </div>
 </div>
 <article>
  <div class="article_content clearfix csdn-tracking-statistics" data-dsm="post" data-mod="popu_307" data-pid="blog" id="article_content">
   <link href="https://csdnimg.cn/release/phoenix/template/css/htmledit_views-0a60691e80.css" rel="stylesheet"/>
   <div class="htmledit_views">
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      =====================================================
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      Media Player Classic - HC 源代码分析系列文章列表：
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13280659">
       Media Player Classic - HC 源代码分析 1：整体结构
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13290345">
       Media Player Classic - HC 源代码分析 2：核心类 （CMainFrame）（1）
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13297291">
       Media Player Classic - HC 源代码分析 3：核心类 （CMainFrame）（2）
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13298397">
       Media Player Classic - HC 源代码分析 4：核心类 （CMainFrame）（3）
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13297555">
       Media Player Classic - HC 源代码分析 5：关于对话框 （CAboutDlg）
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13297589">
       Media Player Classic - HC 源代码分析 6：MediaInfo选项卡 （CPPageFileMediaInfo）
      </a>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:14px;color:rgb(51,51,51);line-height:26px;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13297621">
       Media Player Classic - HC 源代码分析 7：详细信息选项卡（CPPageFileInfoDetails）
      </a>
      <br/>
     </span>
    </p>
    <p>
     <span style="color:rgb(51,51,51);font-family:Arial;font-size:14px;line-height:26px;">
      =====================================================
     </span>
    </p>
    <span style="color:#660000;">
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/13297621" style="line-height:30px;font-family:Arial;text-decoration:none;">
     </a>
    </span>
    <br/>
    <p style="text-align:center;">
     <img alt="" src="https://img-blog.csdn.net/20140616104453250"/>
     <br/>
    </p>
    <p>
     上一篇文章分析了Media Player Classic - HC（mpc-hc）的源代码中的核心类 CMainFrame：
     <span style="color:#cc6600;">
      <a href="http://blog.csdn.net/leixiaohua1020/article/details/13290345">
       Media Player Classic - HC 源代码分析 2：核心类 （CMainFrame）（1）
      </a>
     </span>
    </p>
    <p>
     主要介绍了CMainFrame类中的以下几个函数（“-&gt;”代表调用关系）：
    </p>
    <p>
     <span style="font-size:12px;">
      <span style="font-family:Arial;color:#333333;line-height:26px;">
       OpenMedia()
      </span>
      -&gt;
     </span>
     <span style="font-family:Arial;font-size:12px;color:#333333;line-height:26px;">
      OpenMediaPrivate()-&gt;
     </span>
     <span style="font-family:Arial;font-size:12px;color:#333333;line-height:26px;">
      OpenFile()
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
       本文补充介绍CMainFrame类中的其他一些函数。
      </span>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
       再回顾一下打开文件功能主要所在的函数OpenMediaPrivate()：
      </span>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
      </span>
     </span>
    </p>
    <pre class="cpp">//打开一个媒体（private）
bool CMainFrame::OpenMediaPrivate(CAutoPtr&lt;OpenMediaData&gt; pOMD)
{
	//获得设置信息
    CAppSettings&amp; s = AfxGetAppSettings();

    if (m_iMediaLoadState != MLS_CLOSED) {
        ASSERT(0);
        return false;
    }
	//OpenFileData
	//OpenDVDData
	//OpenDeviceData
	//里面包含了文件或者DVD信息（名称等）
    OpenFileData* pFileData = dynamic_cast&lt;OpenFileData*&gt;(pOMD.m_p);
    OpenDVDData* pDVDData = dynamic_cast&lt;OpenDVDData*&gt;(pOMD.m_p);
    OpenDeviceData* pDeviceData = dynamic_cast&lt;OpenDeviceData*&gt;(pOMD.m_p);
    if (!pFileData &amp;&amp; !pDVDData  &amp;&amp; !pDeviceData) {
        ASSERT(0);
        return false;
    }

    // Clear DXVA state ...
    ClearDXVAState();

#ifdef _DEBUG
    // Debug trace code - Begin
    // Check for bad / buggy auto loading file code
    if (pFileData) {
        POSITION pos = pFileData-&gt;fns.GetHeadPosition();
        UINT index = 0;
        while (pos != nullptr) {
            CString path = pFileData-&gt;fns.GetNext(pos);
            TRACE(_T("--&gt; CMainFrame::OpenMediaPrivate - pFileData-&gt;fns[%d]:\n"), index);
            TRACE(_T("\t%ws\n"), path.GetString()); // %ws - wide character string always
            index++;
        }
    }
    // Debug trace code - End
#endif

    CString mi_fn = _T("");

    if (pFileData) {
        if (pFileData-&gt;fns.IsEmpty()) {
            return false;
        }

        CString fn = pFileData-&gt;fns.GetHead();

        int i = fn.Find(_T(":\\"));
        if (i &gt; 0) {
            CString drive = fn.Left(i + 2);
            UINT type = GetDriveType(drive);
            CAtlList&lt;CString&gt; sl;
            if (type == DRIVE_REMOVABLE || type == DRIVE_CDROM &amp;&amp; GetCDROMType(drive[0], sl) != CDROM_Audio) {
                int ret = IDRETRY;
                while (ret == IDRETRY) {
                    WIN32_FIND_DATA findFileData;
                    HANDLE h = FindFirstFile(fn, &amp;findFileData);
                    if (h != INVALID_HANDLE_VALUE) {
                        FindClose(h);
                        ret = IDOK;
                    } else {
                        CString msg;
                        msg.Format(IDS_MAINFRM_114, fn);
                        ret = AfxMessageBox(msg, MB_RETRYCANCEL);
                    }
                }

                if (ret != IDOK) {
                    return false;
                }
            }
            mi_fn = fn;
        }
    }

    SetLoadState(MLS_LOADING);

    // FIXME: Don't show "Closed" initially
    PostMessage(WM_KICKIDLE);

    CString err;

    m_fUpdateInfoBar = false;
    BeginWaitCursor();

    try {
        CComPtr&lt;IVMRMixerBitmap9&gt;    pVMB;
        CComPtr&lt;IMFVideoMixerBitmap&gt; pMFVMB;
        CComPtr&lt;IMadVRTextOsd&gt;       pMVTO;
        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }

        OpenCreateGraphObject(pOMD);

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }

        SetupIViAudReg();

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }
		//按类型的不同打开不同的文件
        if (pFileData) {
			//文件
            OpenFile(pFileData);
        } else if (pDVDData) {
			//DVD
            OpenDVD(pDVDData);
        } else if (pDeviceData) {
            if (s.iDefaultCaptureDevice == 1) {
                HRESULT hr = OpenBDAGraph();
                if (FAILED(hr)) {
                    throw (UINT)IDS_CAPTURE_ERROR_DEVICE;
                }
            } else {
                OpenCapture(pDeviceData);
            }
        } else {
            throw (UINT)IDS_INVALID_PARAMS_ERROR;
        }

        m_pCAP2 = nullptr;
        m_pCAP = nullptr;
		//查找接口
        m_pGB-&gt;FindInterface(__uuidof(ISubPicAllocatorPresenter), (void**)&amp;m_pCAP, TRUE);
        m_pGB-&gt;FindInterface(__uuidof(ISubPicAllocatorPresenter2), (void**)&amp;m_pCAP2, TRUE);
        m_pGB-&gt;FindInterface(__uuidof(IVMRWindowlessControl9), (void**)&amp;m_pVMRWC, FALSE); // might have IVMRMixerBitmap9, but not IVMRWindowlessControl9
        m_pGB-&gt;FindInterface(__uuidof(IVMRMixerControl9), (void**)&amp;m_pVMRMC, TRUE);
        m_pGB-&gt;FindInterface(__uuidof(IVMRMixerBitmap9), (void**)&amp;pVMB, TRUE);
        m_pGB-&gt;FindInterface(__uuidof(IMFVideoMixerBitmap), (void**)&amp;pMFVMB, TRUE);
        pMVTO = m_pCAP;

        if (s.fShowOSD || s.fShowDebugInfo) { // Force OSD on when the debug switch is used
            if (pVMB) {
                m_OSD.Start(m_pVideoWnd, pVMB, IsD3DFullScreenMode());
            } else if (pMFVMB) {
                m_OSD.Start(m_pVideoWnd, pMFVMB, IsD3DFullScreenMode());
            } else if (pMVTO) {
                m_OSD.Start(m_pVideoWnd, pMVTO);
            }
        }
		//VMR9
        SetupVMR9ColorControl();

        // === EVR !
        m_pGB-&gt;FindInterface(__uuidof(IMFVideoDisplayControl), (void**)&amp;m_pMFVDC,  TRUE);
        m_pGB-&gt;FindInterface(__uuidof(IMFVideoProcessor), (void**)&amp;m_pMFVP, TRUE);
        if (m_pMFVDC) {
            m_pMFVDC-&gt;SetVideoWindow(m_pVideoWnd-&gt;m_hWnd);
        }

        //SetupEVRColorControl();
        //does not work at this location
        //need to choose the correct mode (IMFVideoProcessor::SetVideoProcessorMode)

        BeginEnumFilters(m_pGB, pEF, pBF) {
            if (m_pLN21 = pBF) {
                m_pLN21-&gt;SetServiceState(s.fClosedCaptions ? AM_L21_CCSTATE_On : AM_L21_CCSTATE_Off);
                break;
            }
        }
        EndEnumFilters;

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }
		//打开自定义的Graph
        OpenCustomizeGraph();

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }
		//设置视频窗口
        OpenSetupVideo();

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }
		//设置音量
        OpenSetupAudio();

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }

        if (m_pCAP &amp;&amp; (!m_fAudioOnly || m_fRealMediaGraph)) {

            if (s.fDisableInternalSubtitles) {
                m_pSubStreams.RemoveAll(); // Needs to be replaced with code that checks for forced subtitles.
            }

            m_posFirstExtSub = nullptr;
            POSITION pos = pOMD-&gt;subs.GetHeadPosition();
            while (pos) {
                LoadSubtitle(pOMD-&gt;subs.GetNext(pos), nullptr, true);
            }
        }

        if (m_fOpeningAborted) {
            throw (UINT)IDS_AG_ABORTED;
        }
		//设置视频窗口标题
        OpenSetupWindowTitle(pOMD-&gt;title);

        if (s.fEnableEDLEditor) {
            m_wndEditListEditor.OpenFile(pOMD-&gt;title);
        }

        if (::GetCurrentThreadId() == AfxGetApp()-&gt;m_nThreadID) {
            OnFilePostOpenmedia();
        } else {
            PostMessage(WM_COMMAND, ID_FILE_POST_OPENMEDIA);
        }

        while (m_iMediaLoadState != MLS_LOADED
                &amp;&amp; m_iMediaLoadState != MLS_CLOSING // FIXME
              ) {
            Sleep(50);
        }
		//设置音频流
        DWORD audstm = SetupAudioStreams();
		//设置字幕流
        DWORD substm = SetupSubtitleStreams();

        if (audstm) {
            OnPlayAudio(ID_AUDIO_SUBITEM_START + audstm);
        }
        if (substm) {
            SetSubtitle(substm - 1);
        }

        // PostMessage instead of SendMessage because the user might call CloseMedia and then we would deadlock

        PostMessage(WM_COMMAND, ID_PLAY_PAUSE);

        m_bFirstPlay = true;

        if (!(s.nCLSwitches &amp; CLSW_OPEN) &amp;&amp; (s.nLoops &gt; 0)) {
            PostMessage(WM_COMMAND, ID_PLAY_PLAY);
        } else {
            // If we don't start playing immediately, we need to initialize
            // the seekbar and the time counter.
            OnTimer(TIMER_STREAMPOSPOLLER);
            OnTimer(TIMER_STREAMPOSPOLLER2);
        }

        s.nCLSwitches &amp;= ~CLSW_OPEN;

        if (pFileData) {
            if (pFileData-&gt;rtStart &gt; 0) {
                PostMessage(WM_RESUMEFROMSTATE, (WPARAM)PM_FILE, (LPARAM)(pFileData-&gt;rtStart / 10000));  // REFERENCE_TIME doesn't fit in LPARAM under a 32bit env.
            }
        } else if (pDVDData) {
            if (pDVDData-&gt;pDvdState) {
                PostMessage(WM_RESUMEFROMSTATE, (WPARAM)PM_DVD, (LPARAM)(CComPtr&lt;IDvdState&gt;(pDVDData-&gt;pDvdState).Detach()));    // must be released by the called message handler
            }
        } else if (pDeviceData) {
            m_wndCaptureBar.m_capdlg.SetVideoInput(pDeviceData-&gt;vinput);
            m_wndCaptureBar.m_capdlg.SetVideoChannel(pDeviceData-&gt;vchannel);
            m_wndCaptureBar.m_capdlg.SetAudioInput(pDeviceData-&gt;ainput);
        }
    } catch (LPCTSTR msg) {
        err = msg;
    } catch (CString&amp; msg) {
        err = msg;
    } catch (UINT msg) {
        err.LoadString(msg);
    }

    EndWaitCursor();

    if (!err.IsEmpty()) {
		//关闭
        CloseMediaPrivate();
        m_closingmsg = err;

        if (err != ResStr(IDS_AG_ABORTED)) {
            if (pFileData) {
                m_wndPlaylistBar.SetCurValid(false);

                if (m_wndPlaylistBar.IsAtEnd()) {
                    m_nLoops++;
                }

                if (s.fLoopForever || m_nLoops &lt; s.nLoops) {
                    bool hasValidFile = false;

                    if (m_nLastSkipDirection == ID_NAVIGATE_SKIPBACK) {
                        hasValidFile = m_wndPlaylistBar.SetPrev();
                    } else {
                        hasValidFile = m_wndPlaylistBar.SetNext();
                    }

                    if (hasValidFile) {
                        OpenCurPlaylistItem();
                    }
                } else if (m_wndPlaylistBar.GetCount() &gt; 1) {
                    DoAfterPlaybackEvent();
                }
            } else {
                OnNavigateSkip(ID_NAVIGATE_SKIPFORWARD);
            }
        }
    } else {
        m_wndPlaylistBar.SetCurValid(true);

        // Apply command line audio shift
        if (s.rtShift != 0) {
            SetAudioDelay(s.rtShift);
            s.rtShift = 0;
        }
    }

    m_nLastSkipDirection = 0;

    if (s.AutoChangeFullscrRes.bEnabled &amp;&amp; (m_fFullScreen || IsD3DFullScreenMode())) {
        AutoChangeMonitorMode();
    }
    if (m_fFullScreen &amp;&amp; s.fRememberZoomLevel) {
        m_fFirstFSAfterLaunchOnFS = true;
    }

    m_LastOpenFile = pOMD-&gt;title;

    PostMessage(WM_KICKIDLE); // calls main thread to update things

    if (!m_bIsBDPlay) {
        m_MPLSPlaylist.RemoveAll();
        m_LastOpenBDPath = _T("");
    }
    m_bIsBDPlay = false;

    return err.IsEmpty();
}</pre>
    <br/>
    来看一看OpenMediaPrivate()函数的细节：
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
       1.开始的时候有这么一句
      </span>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
      </span>
     </span>
    </p>
    <pre class="cpp">CAppSettings&amp; s = AfxGetAppSettings();</pre>
    <br/>
    在这里涉及到一个类CAppSettings，存储的是mpc-hc用到的各种设置信息。源代码如下：
    <p>
    </p>
    <p>
    </p>
    <pre class="cpp">//应用程序中的各种参数
class CAppSettings
{
    bool fInitialized;

    class CRecentFileAndURLList : public CRecentFileList
    {
    public:
        CRecentFileAndURLList(UINT nStart, LPCTSTR lpszSection,
                              LPCTSTR lpszEntryFormat, int nSize,
                              int nMaxDispLen = AFX_ABBREV_FILENAME_LEN);

        virtual void Add(LPCTSTR lpszPathName); // we have to override CRecentFileList::Add because the original version can't handle URLs
    };

public:
    bool fShaderEditorWasOpened;

    // cmdline params
    UINT nCLSwitches;
    CAtlList&lt;CString&gt;   slFiles, slDubs, slSubs, slFilters;

    // Initial position (used by command line flags)
    REFERENCE_TIME      rtShift;
    REFERENCE_TIME      rtStart;
    ULONG               lDVDTitle;
    ULONG               lDVDChapter;
    DVD_HMSF_TIMECODE   DVDPosition;

    CSize sizeFixedWindow;
    bool HasFixedWindowSize() const { return sizeFixedWindow.cx &gt; 0 || sizeFixedWindow.cy &gt; 0; }
    //int           iFixedWidth, iFixedHeight;
    int             iMonitor;

    CString         ParseFileName(CString const&amp; param);
    void            ParseCommandLine(CAtlList&lt;CString&gt;&amp; cmdln);

    // Added a Debug display to the screen (/debug option)
    bool            fShowDebugInfo;
    int             iAdminOption;


    //播放器 Player
    bool            fAllowMultipleInst;
    bool            fTrayIcon;
    bool            fShowOSD;
    bool            fLimitWindowProportions;
    bool            fSnapToDesktopEdges;
    bool            fHideCDROMsSubMenu;
    DWORD           dwPriority;
    int             iTitleBarTextStyle;
    bool            fTitleBarTextTitle;
    bool            fKeepHistory;
    CRecentFileAndURLList MRU;
    CRecentFileAndURLList MRUDub;
    CFilePositionList filePositions;
    CDVDPositionList  dvdPositions;
    bool            fRememberDVDPos;
    bool            fRememberFilePos;
    bool            bRememberPlaylistItems;
    bool            fRememberWindowPos;
    CRect           rcLastWindowPos;
    bool            fRememberWindowSize;
    bool            fSavePnSZoom;
    double          dZoomX;
    double          dZoomY;

    // Formats
    CMediaFormats   m_Formats;
    bool            fAssociatedWithIcons;

    // Keys
    CList&lt;wmcmd&gt;    wmcmds;
    HACCEL          hAccel;
    bool            fWinLirc;
    CString         strWinLircAddr;
    CWinLircClient  WinLircClient;
    bool            fUIce;
    CString         strUIceAddr;
    CUIceClient     UIceClient;
    bool            fGlobalMedia;

    //图标 Logo
    UINT            nLogoId;
    bool            fLogoExternal;
    CString         strLogoFileName;

    //web界面？ Web Inteface
    BOOL            fEnableWebServer;
    int             nWebServerPort;
    int             nCmdlnWebServerPort;
    bool            fWebServerUseCompression;
    bool            fWebServerLocalhostOnly;
    bool            fWebServerPrintDebugInfo;
    CString         strWebRoot, strWebDefIndex;
    CString         strWebServerCGI;

    //播放时候 Playback
    int             nVolume;
    bool            fMute;
    int             nBalance;
    int             nLoops;
    bool            fLoopForever;
    bool            fRewind;
    bool            fRememberZoomLevel;
    int             nAutoFitFactor;
    int             iZoomLevel;
    CStringW        strAudiosLanguageOrder;
    CStringW        strSubtitlesLanguageOrder;
    bool            fEnableWorkerThreadForOpening;
    bool            fReportFailedPins;
    bool            fAutoloadAudio;
    bool            fAutoloadSubtitles;
    bool            fBlockVSFilter;
    UINT            nVolumeStep;
    UINT            nSpeedStep;

    // DVD/OGM
    bool            fUseDVDPath;
    CString         strDVDPath;
    LCID            idMenuLang, idAudioLang, idSubtitlesLang;
    bool            fAutoSpeakerConf;
    bool            fClosedCaptions;

    //输出 Output
    CRenderersSettings m_RenderersSettings;
    int             iDSVideoRendererType;
    int             iRMVideoRendererType;
    int             iQTVideoRendererType;

    CStringW        strAudioRendererDisplayName;
    bool            fD3DFullscreen;

    //全屏 Fullscreen
    bool            fLaunchfullscreen;
    bool            fShowBarsWhenFullScreen;
    int             nShowBarsWhenFullScreenTimeOut;
    bool            fExitFullScreenAtTheEnd;
    CStringW        strFullScreenMonitor;
    AChFR           AutoChangeFullscrRes;
    bool            fRestoreResAfterExit;

    // Sync Renderer Settings

    // Capture (BDA configuration)
    int             iDefaultCaptureDevice;      // Default capture device (analog=0, 1=digital)
    CString         strAnalogVideo;
    CString         strAnalogAudio;
    int             iAnalogCountry;
    CString         strBDANetworkProvider;
    CString         strBDATuner;
    CString         strBDAReceiver;
    //CString           strBDAStandard;
    int             iBDAScanFreqStart;
    int             iBDAScanFreqEnd;
    int             iBDABandwidth;
    bool            fBDAUseOffset;
    int             iBDAOffset;
    bool            fBDAIgnoreEncryptedChannels;
    UINT            nDVBLastChannel;
    CAtlList&lt;CDVBChannel&gt; m_DVBChannels;
    DVB_RebuildFilterGraph nDVBRebuildFilterGraph;
    DVB_StopFilterGraph nDVBStopFilterGraph;

    // Internal Filters
    bool            SrcFilters[SRC_LAST + !SRC_LAST];
    bool            TraFilters[TRA_LAST + !TRA_LAST];

    //音频 Audio Switcher
    bool            fEnableAudioSwitcher;
    bool            fAudioNormalize;
    UINT            nAudioMaxNormFactor;
    bool            fAudioNormalizeRecover;
    UINT            nAudioBoost;
    bool            fDownSampleTo441;
    bool            fAudioTimeShift;
    int             iAudioTimeShift;
    bool            fCustomChannelMapping;
    int             nSpeakerChannels;
    DWORD           pSpeakerToChannelMap[AS_MAX_CHANNELS][AS_MAX_CHANNELS];

    // External Filters
    CAutoPtrList&lt;FilterOverride&gt; m_filters;

    //字幕 Subtitles
    bool            fOverridePlacement;
    int             nHorPos, nVerPos;
    int             nSubDelayInterval;

    // Default Style
    STSStyle        subdefstyle;

    // Misc
    bool            bPreferDefaultForcedSubtitles;
    bool            fPrioritizeExternalSubtitles;
    bool            fDisableInternalSubtitles;
    bool            bAllowOverridingExternalSplitterChoice;
    CString         strSubtitlePaths;
    CString         strISDb;

    // Tweaks
    int             nJumpDistS;
    int             nJumpDistM;
    int             nJumpDistL;
    bool            fFastSeek;
    bool            fShowChapters;
    bool            bNotifySkype;
    bool            fPreventMinimize;
    bool            fUseWin7TaskBar;
    bool            fLCDSupport;
    bool            fUseSearchInFolder;
    bool            fUseTimeTooltip;
    int             nTimeTooltipPosition;
    CString         strOSDFont;
    int             nOSDSize;

    //亮度色度饱和度 Miscellaneous
    int             iBrightness;
    int             iContrast;
    int             iHue;
    int             iSaturation;
    int             nUpdaterAutoCheck;
    int             nUpdaterDelay;

    // MENUS
    // View
    int             iCaptionMenuMode; // normal -&gt; hidemenu -&gt; frameonly -&gt; borderless
    bool            fHideNavigation;
    UINT            nCS; // Control state for toolbars
    // Language
    LANGID          language;
    // Subtitles menu
    bool            fEnableSubtitles;
    bool            fUseDefaultSubtitlesStyle;
    // Video Frame
    int             iDefaultVideoSize;
    bool            fKeepAspectRatio;
    CSize           sizeAspectRatio;
    bool            fCompMonDeskARDiff;
    // Pan&amp;Scan
    CString         strPnSPreset;
    CStringArray    m_pnspresets;
    // On top menu
    int             iOnTop;
    // After Playback
    bool            fExitAfterPlayback;
    bool            fNextInDirAfterPlayback;

    // WINDOWS
    // Add Favorite
    bool            bFavRememberPos;
    bool            bFavRelativeDrive;
    // Save Image...
    CString         strSnapShotPath, strSnapShotExt;
    // Save Thumbnails...
    int             iThumbRows, iThumbCols, iThumbWidth;
    // Shader Editor
    struct Shader {
        CString     label;
        CString     target;
        CString     srcdata;
    };
    CAtlList&lt;Shader&gt; m_shaders;
    // Shader Combiner
    bool            fToggleShader;
    bool            fToggleShaderScreenSpace;
    CString         strShaderList;
    CString         strShaderListScreenSpace;
    // Playlist (contex menu)
    bool            bShufflePlaylistItems;
    bool            bHidePlaylistFullScreen;

    // OTHER STATES
    CStringW        strLastOpenDir;
    UINT            nLastWindowType;
    UINT            nLastUsedPage;
    bool            fRemainingTime;
    bool            fLastFullScreen;

    bool            fIntRealMedia;
    //bool          fRealMediaRenderless;
    //float         dRealMediaQuickTimeFPS;
    //int           iVideoRendererType;
    //int           iQuickTimeRenderer;
    //bool          fMonitorAutoRefreshRate;
    bool            fEnableEDLEditor;

    HWND            hMasterWnd;

    bool            IsD3DFullscreen() const;
    CString         SelectedAudioRenderer() const;
    bool            IsISREnabled() const;

private:
    CString         SrcFiltersKeys[SRC_LAST + !SRC_LAST];
    CString         TraFiltersKeys[TRA_LAST + !TRA_LAST];

    __int64         ConvertTimeToMSec(const CString&amp; time) const;
    void            ExtractDVDStartPos(CString&amp; strParam);

    void            CreateCommands();

    void            SaveExternalFilters(CAutoPtrList&lt;FilterOverride&gt;&amp; filters, LPCTSTR baseKey = IDS_R_EXTERNAL_FILTERS);
    void            LoadExternalFilters(CAutoPtrList&lt;FilterOverride&gt;&amp; filters, LPCTSTR baseKey = IDS_R_EXTERNAL_FILTERS);
    void            ConvertOldExternalFiltersList();

    void            UpdateRenderersData(bool fSave);
    friend void     CRenderersSettings::UpdateData(bool bSave);

public:
    CAppSettings();
    virtual ~CAppSettings();

    void            SaveSettings();
    void            LoadSettings();
    void            SaveExternalFilters() { if (fInitialized) { SaveExternalFilters(m_filters); } };

    void            GetFav(favtype ft, CAtlList&lt;CString&gt;&amp; sl) const;
    void            SetFav(favtype ft, CAtlList&lt;CString&gt;&amp; sl);
    void            AddFav(favtype ft, CString s);

    CDVBChannel*    FindChannelByPref(int nPrefNumber);

    bool            GetAllowMultiInst() const;

    static bool     IsVSFilterInstalled();
    static bool     HasEVR();
};</pre>
    <br/>
    由代码可见，包含的参数信息很多。在mpc-hc中，任何需要获取设置信息的地方，都可以使用AfxGetAppSettings()获得CAppSettings的引用。
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
       2.OpenSetupVideo()这个函数的作用是设置视频窗口，源代码如下：
      </span>
     </span>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
      </span>
     </span>
    </p>
    <pre class="cpp">//设置视频窗口
void CMainFrame::OpenSetupVideo()
{
	//大部分都在确定：m_fAudioOnly是否为True
    m_fAudioOnly = true;
	//获得视频的宽和高，然后调整窗口大小
    if (m_pMFVDC) { // EVR
        m_fAudioOnly = false;
    } else if (m_pCAP) {
        CSize vs = m_pCAP-&gt;GetVideoSize();
        m_fAudioOnly = (vs.cx &lt;= 0 || vs.cy &lt;= 0);
    } else {
        {
            long w = 0, h = 0;

            if (CComQIPtr&lt;IBasicVideo&gt; pBV = m_pGB) {
                pBV-&gt;GetVideoSize(&amp;w, &amp;h);
            }

            if (w &gt; 0 &amp;&amp; h &gt; 0) {
                m_fAudioOnly = false;
            }
        }
		//如果 m_fAudioOnly=true；再检查
        if (m_fAudioOnly) {
            BeginEnumFilters(m_pGB, pEF, pBF) {
                long w = 0, h = 0;

                if (CComQIPtr&lt;IVideoWindow&gt; pVW = pBF) {
                    long lVisible;
                    if (FAILED(pVW-&gt;get_Visible(&amp;lVisible))) {
                        continue;
                    }

                    pVW-&gt;get_Width(&amp;w);
                    pVW-&gt;get_Height(&amp;h);
                }

                if (w &gt; 0 &amp;&amp; h &gt; 0) {
                    m_fAudioOnly = false;
                    break;
                }
            }
            EndEnumFilters;
        }
    }

    if (m_fShockwaveGraph) {
        m_fAudioOnly = false;
    }

    if (m_pCAP) {
        SetShaders();
    }
    // else
    {
        // TESTME
		//设置所有者。。。
        m_pVW-&gt;put_Owner((OAHWND)m_pVideoWnd-&gt;m_hWnd);
        m_pVW-&gt;put_WindowStyle(WS_CHILD | WS_CLIPSIBLINGS | WS_CLIPCHILDREN);
        m_pVW-&gt;put_MessageDrain((OAHWND)m_hWnd);

        for (CWnd* pWnd = m_wndView.GetWindow(GW_CHILD); pWnd; pWnd = pWnd-&gt;GetNextWindow()) {
            pWnd-&gt;EnableWindow(FALSE);    // little trick to let WM_SETCURSOR thru
        }
    }
	//如果只有音频，则消灭视频窗口！
    if (m_fAudioOnly &amp;&amp; IsD3DFullScreenMode()) {
        m_pFullscreenWnd-&gt;DestroyWindow();
    }
}</pre>
    <br/>
    <span style="font-family:Arial;font-size:12px;line-height:26px;">
     3.
    </span>
    <span style="font-family:Arial;font-size:12px;line-height:26px;">
     OpenSetupAudio()这个函数的作用是设置音频，源代码如下：
    </span>
    <br/>
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
      </span>
     </span>
    </p>
    <pre class="cpp">//设置音量
void CMainFrame::OpenSetupAudio()
{
	//设置音量
    m_pBA-&gt;put_Volume(m_wndToolBar.Volume);

    // FIXME
    int balance = AfxGetAppSettings().nBalance;

    int sign = balance &gt; 0 ? -1 : 1; // -1: invert sign for more right channel
    if (balance &gt; -100 &amp;&amp; balance &lt; 100) {
        balance = sign * (int)(100 * 20 * log10(1 - abs(balance) / 100.0f));
    } else {
        balance = sign * (-10000);  // -10000: only left, 10000: only right
    }
	//设置均衡
    m_pBA-&gt;put_Balance(balance);
}</pre>
    <br/>
    4.如果出现问题，则会调用CloseMediaPrivate()，关闭打开的媒体。
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
      </span>
     </span>
    </p>
    <pre class="cpp">//关闭
void CMainFrame::CloseMediaPrivate()
{
    SetLoadState(MLS_CLOSING); // why it before OnPlayStop()? // TODO: remake or add detailed comments
    OnPlayStop(); // SendMessage(WM_COMMAND, ID_PLAY_STOP);
    if (m_pMC) {
        m_pMC-&gt;Stop(); // needed for StreamBufferSource, because m_iMediaLoadState is always MLS_CLOSED // TODO: fix the opening for such media
    }
    SetPlaybackMode(PM_NONE);
    m_fLiveWM = false;
    m_fEndOfStream = false;
    m_rtDurationOverride = -1;
    m_kfs.RemoveAll();
    m_pCB.Release();

    {
        CAutoLock cAutoLock(&amp;m_csSubLock);
        m_pSubStreams.RemoveAll();
    }
    m_pSubClock.Release();

    //if (m_pVW) m_pVW-&gt;put_Visible(OAFALSE);
    //if (m_pVW) m_pVW-&gt;put_MessageDrain((OAHWND)NULL), m_pVW-&gt;put_Owner((OAHWND)NULL);

    // IMPORTANT: IVMRSurfaceAllocatorNotify/IVMRSurfaceAllocatorNotify9 has to be released before the VMR/VMR9, otherwise it will crash in Release()
    //各种清空
	m_OSD.Stop();
    m_pCAP2.Release();
    m_pCAP.Release();
    m_pVMRWC.Release();
    m_pVMRMC.Release();
    m_pMFVP.Release();
    m_pMFVDC.Release();
    m_pLN21.Release();
    m_pSyncClock.Release();

    m_pAMXBar.Release();
    m_pAMDF.Release();
    m_pAMVCCap.Release();
    m_pAMVCPrev.Release();
    m_pAMVSCCap.Release();
    m_pAMVSCPrev.Release();
    m_pAMASC.Release();
    m_pVidCap.Release();
    m_pAudCap.Release();
    m_pAMTuner.Release();
    m_pCGB.Release();

    m_pDVDC.Release();
    m_pDVDI.Release();
    m_pAMOP.Release();
    m_pBI.Release();
    m_pQP.Release();
    m_pFS.Release();
    m_pMS.Release();
    m_pBA.Release();
    m_pBV.Release();
    m_pVW.Release();
    m_pME.Release();
    m_pMC.Release();

    if (m_pGB) {
        m_pGB-&gt;RemoveFromROT();
        m_pGB.Release();
    }

    m_pProv.Release();

    m_fRealMediaGraph = m_fShockwaveGraph = m_fQuicktimeGraph = false;

    m_VidDispName.Empty();
    m_AudDispName.Empty();

    m_closingmsg.LoadString(IDS_CONTROLS_CLOSED);

    AfxGetAppSettings().nCLSwitches &amp;= CLSW_OPEN | CLSW_PLAY | CLSW_AFTERPLAYBACK_MASK | CLSW_NOFOCUS;
	//设置状态
    SetLoadState(MLS_CLOSED);
}</pre>
    <br/>
    <br/>
    <p>
    </p>
    <p>
     <span style="font-family:Arial;font-size:12px;">
      <span style="line-height:26px;">
       <br/>
      </span>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
    <p>
     <span style="color:#cc6600;">
      <br/>
     </span>
    </p>
   </div>
  </div>
  <div style="display:none;" class="hide-article-box text-center csdn-tracking-statistics tracking-click" data-mod="popu_376">
   <a class="btn btn-red-hollow" id="btn-readmore">
    阅读更多
   </a>
  </div>
 </article>
 <div class="article-bar-bottom">
  <div class="article-copyright">
   版权声明：本文为博主原创文章，未经博主允许不得转载。			https://blog.csdn.net/leixiaohua1020/article/details/13297291
  </div>
  <div class="tags-box artic-tag-box">
   <span class="label">
    文章标签：
   </span>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=mpc-hc&amp;t=blog" target="_blank">
    mpc-hc
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=源代码&amp;t=blog" target="_blank">
    源代码
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=directshow&amp;t=blog" target="_blank">
    directshow
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=播放器&amp;t=blog" target="_blank">
    播放器
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=开源&amp;t=blog" target="_blank">
    开源
   </a>
  </div>
  <div class="tags-box">
   <span class="label">
    个人分类：
   </span>
   <a class="tag-link" href="https://blog.csdn.net/leixiaohua1020/article/category/2286581" target="_blank">
    MPC-HC
   </a>
  </div>
  <div class="tags-box">
   <span class="label">
    所属专栏：
   </span>
   <a class="tag-link" href="https://blog.csdn.net/column/details/osmedia.html" target="_blank">
    开源多媒体项目源代码分析
   </a>
  </div>
 </div>
 <!-- !empty($pre_next_article[0]) -->
</div>
<div class="recommend-box">
                            <div style="background: #fff; border: dashed 1px #666; padding-left: 1em; padding-top: 1em; padding-bottom: 1em;">
                                <span style="font-size: 0.8em; font-weight: bold;">
                                    此PDF由<a style="color:#0000ff" href="http://www.github.com/spygg"  target="_blank">spygg</a>生成,请尊重原作者版权!!!
                                    <br/>
                                    我的邮箱:liushidc@163.com
                                </span>
                                </div> 
                        </div>
                    </main>
      
                </div>

            <script>
                var recommendCount = 0;
                var articleTit = "";
                var articleId = "";
                var commentscount = 0;

                //1禁止评论，2正常
                var commentAuth = 1;
                //百度搜索
                var baiduKey = "";
                var needInsertBaidu = "";
            </script>
            <script src="https://csdnimg.cn/release/phoenix/template/js/detail-effe72036e.min.js"></script>
            </body>
        </html>