
            <!DOCTYPE html>
            <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>
 FFmpeg的H.264解码器源代码简单分析：概述 - CSDN博客
</title>

                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/detail-60a2c245da.min.css">
                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/themes/skin3-template/skin3-template-88717cedf2.min.css">

                <script type="text/javascript">
                var username = "";
                </script>

                <script src="https://csdnimg.cn/public/common/libs/jquery/jquery-1.9.1.min.js" type="text/javascript"></script>

                <!-- 新版上报 -->
                <!-- 新版上报end -->
                <link rel="stylesheet" href="https://csdnimg.cn/public/sandalstrap/1.3/css/sandalstrap.min.css"> 
                </head>
                <body>    
        
                    <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/blog_code-c3a0c33d5c.css">
                    <div class="container clearfix pt0" id="mainBox">
        <main style="width: 100%;"><div class="blog-content-box">
 <div class="article-title-box" id="article_anchors_71">
  <span class="article-type type-1 float-left">
   原
  </span>
  <h1 class="title-article">
   FFmpeg的H.264解码器源代码简单分析：概述
  </h1>
 </div>
 <div class="article-info-box">
  <div class="article-bar-top d-flex">
   <span class="time">
    2015年04月04日 01:09:18
   </span>
   <div ">
    <span class="read-count">
     阅读数：24197
    </span>
   </div>
  </div>
 </div>
 <article>
  <div class="article_content clearfix csdn-tracking-statistics" data-dsm="post" data-mod="popu_307" data-pid="blog" id="article_content">
   <link href="https://csdnimg.cn/release/phoenix/template/css/htmledit_views-0a60691e80.css" rel="stylesheet"/>
   <div class="htmledit_views">
    <p>
    </p>
    <p>
     =====================================================
    </p>
    <p>
     H.264源代码分析文章列表：
    </p>
    <p>
     【编码 - x264】
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45536607">
      x264源代码简单分析：概述
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45583217">
      x264源代码简单分析：x264命令行工具（x264.exe）
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45644367">
      x264源代码简单分析：编码器主干部分-1
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45719905">
      x264源代码简单分析：编码器主干部分-2
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45790195">
      x264源代码简单分析：x264_slice_write()
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45870269">
      x264源代码简单分析：滤波（Filter）部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45917757">
      x264源代码简单分析：宏块分析（Analysis）部分-帧内宏块（Intra）
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45936267">
      x264源代码简单分析：宏块分析（Analysis）部分-帧间宏块（Inter）
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45938927">
      x264源代码简单分析：宏块编码（Encode）部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45944811">
      x264源代码简单分析：熵编码（Entropy Encoding）部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45960409">
      FFmpeg与libx264接口源代码简单分析
     </a>
    </p>
    <p>
     【解码 - libavcodec H.264 解码器】
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/44864509">
      FFmpeg的H.264解码器源代码简单分析：概述
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45001033">
      FFmpeg的H.264解码器源代码简单分析：解析器（Parser）部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45042755">
      FFmpeg的H.264解码器源代码简单分析：解码器主干部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45114453">
      FFmpeg的H.264解码器源代码简单分析：熵解码（EntropyDecoding）部分
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45143075">
      FFmpeg的H.264解码器源代码简单分析：宏块解码（Decode）部分-帧内宏块（Intra）
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45195291">
      FFmpeg的H.264解码器源代码简单分析：宏块解码（Decode）部分-帧间宏块（Inter）
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/45224579">
      FFmpeg的H.264解码器源代码简单分析：环路滤波（Loop Filter）部分
     </a>
    </p>
    <p>
     =====================================================
    </p>
    <br/>
    <p>
     本文简单记录FFmpeg中libavcodec的H.264解码器（H.264 Decoder）的源代码。这个H.264解码器十分重要，可以说FFmpeg项目今天可以几乎“垄断”视音频编解码技术，很大一部分贡献就来自于这个H.264解码器。这个H.264解码器一方面功能强大，性能稳定；另一方面源代码也比较复杂，难以深入研究。本文打算梳理一下这个H.264解码器的源代码结构，以方便以后深入学习H.264使用。
    </p>
    <span style="font-family:'FangSong_GB2312';">
     PS：这部分代码挺复杂的，还有不少地方还比较模糊，还需要慢慢学习......
    </span>
    <br/>
    <br/>
    <h2>
     函数调用关系图
    </h2>
    <p>
     H.264解码器的函数调用关系图如下所示。
    </p>
    <p style="text-align:center;">
     <a href="http://img.my.csdn.net/uploads/201504/04/1428080288_9350.jpg">
      <img alt="" src="https://img-blog.csdn.net/20150404005941807"/>
     </a>
     <br/>
    </p>
    <div style="text-align:center;">
     <a href="https://my.csdn.net/leixiaohua1020/album/detail/1806347">
      单击查看更清晰的大图
     </a>
    </div>
    <br/>
    <p>
     下面解释一下图中关键标记的含义。
    </p>
    <p>
    </p>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     <p>
      <br/>
     </p>
     <h3>
      作为接口的结构体
     </h3>
     FFmpeg和H.264解码器之间作为接口的结构体有2个：
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      ff_h264_parser：用于解析H.264码流的AVCodecParser结构体。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      ff_h264_decoder：用于解码H.264码流的AVCodec结构体。
     </blockquote>
     <br/>
     <h3>
      函数背景色
     </h3>
     函数在图中以方框的形式表现出来。不同的背景色标志了该函数不同的作用：
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      白色背景的函数：普通内部函数。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      粉红色背景函数：解析函数（Parser）。这些函数用于解析SPS、PPS等信息。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      紫色背景的函数：熵解码函数（Entropy Decoding）。这些函数读取码流数据并且进行CABAC或者CAVLC熵解码。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      绿色背景的函数：解码函数（Decode）。这些函数通过帧内预测、帧间预测、DCT反变换等方法解码压缩数据。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      黄色背景的函数：环路滤波函数（Loop Filter）。这些函数对解码后的数据进行滤波，去除方块效应。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      蓝色背景函数：汇编函数（Assembly）。这些函数是做过汇编优化的函数。图中主要画出了这些函数的C语言版本，此外这些函数还包含MMX版本、SSE版本、NEON版本等。
     </blockquote>
     <br/>
     <h3>
      箭头线
     </h3>
     箭头线标志了函数的调用关系：
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      黑色箭头线：不加区别的调用关系。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      粉红色的箭头线：解析函数（Parser）之间的调用关系。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      紫色箭头线：熵解码函数（Entropy Decoding）之间的调用关系。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      绿色箭头线：解码函数（Decode）之间的调用关系。
     </blockquote>
     <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
      黄色箭头线：环路滤波函数（Loop Filter）之间的调用关系。
     </blockquote>
     <h3>
      函数所在的文件
     </h3>
     <p>
      每个函数标识了它所在的文件路径。
     </p>
    </blockquote>
    <p>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <br/>
    </p>
    <h2>
     几个关键部分
    </h2>
    <p>
     下文简单记录几个关键的部分。
    </p>
    <p>
     <br/>
    </p>
    <h2>
     FFmpeg和H.264解码器之间作为接口的结构体
    </h2>
    <p>
     FFmpeg和H.264解码器之间作为接口的结构体有2个：ff_h264_parser和ff_h264_decoder。
    </p>
    <strong>
     ff_h264_parser
    </strong>
    <br/>
    ff_h264_parser是用于解析H.264码流的AVCodecParser结构体。AVCodecParser中包含了几个重要的函数指针：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     parser_init()：初始化解析器。
     <br/>
     parser_parse()：解析。
     <br/>
     parser_close()：关闭解析器。
    </blockquote>
    在ff_h264_parser结构体中，上述几个函数指针分别指向下面几个实现函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     init()：初始化H.264解析器。
     <br/>
     h264_parse()：解析H.264码流。
     <br/>
     close()：关闭H.264解析器。
    </blockquote>
    <strong>
     ff_h264_decoder
    </strong>
    <br/>
    ff_h264_decoder是用于解码H.264码流的AVCodec结构体。AVCodec中包含了几个重要的函数指针：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     init()：初始化解码器。
     <br/>
     decode()：解码。
     <br/>
     close()：关闭解码器。
    </blockquote>
    在ff_h264_decoder结构体中，上述几个函数指针分别指向下面几个实现函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     ff_h264_decode_init()：初始化H.264解码器。
     <br/>
     h264_decode_frame()：解码H.264码流。
     <br/>
     h264_decode_end()：关闭H.264解码器。
    </blockquote>
    <br/>
    <h2>
     普通内部函数
    </h2>
    普通内部函数指的是H.264解码器中还没有进行分类的函数。下面举几个例子。
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
    </blockquote>
    ff_h264_decoder中ff_h264_decode_init()调用的初始化函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     ff_h264dsp_init()：初始化DSP相关的函数。包含了IDCT、环路滤波函数等。
     <br/>
     ff_h264qpel_init()：初始化四分之一像素运动补偿相关的函数。
     <br/>
     ff_h264_pred_init()：初始化帧内预测相关的函数。
     <br/>
     ff_h264_decode_extradata()：解析AVCodecContext中的extradata。
    </blockquote>
    ff_h264_decoder中h264_decode_frame()逐层调用的和解码Slice相关的函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     decode_nal_units()，ff_h264_execute_decode_slices()，decode_slice()等。
    </blockquote>
    ff_h264_decoder中h264_decode_end()调用的清理函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     ff_h264_remove_all_refs()：移除所有参考帧。
     <br/>
     ff_h264_free_context()：释放在初始化H.264解码器的时候分配的内存。
     <br/>
    </blockquote>
    ff_h264_parser中h264_parse()逐层调用的和解析Slice相关的函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     h264_find_frame_end()：查找NALU的结尾。
     <br/>
     parse_nal_units()：解析一个NALU。
    </blockquote>
    <br/>
    <h2>
     <span style="color:rgb(255,153,255);">
      解析函数（Parser）
     </span>
    </h2>
    <span style="white-space:pre;">
    </span>
    解析函数（Parser）用于解析H.264码流中的一些信息（例如SPS、PPS、Slice Header等）。在parse_nal_units()和decode_nal_units()中都调用这些解析函数完成了解析。下面举几个解析函数的例子。
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     ff_h264_decode_nal()：解析NALU。这个函数是后几个解析函数的前提。
     <br/>
     ff_h264_decode_slice_header()：解析Slice Header。
     <br/>
     ff_h264_decode_sei()：解析SEI。
     <br/>
     ff_h264_decode_seq_parameter_set()：解析SPS。
     <br/>
     ff_h264_decode_picture_parameter_set()：解析PPS。
    </blockquote>
    <br/>
    <h2>
     <span style="background-color:rgb(255,255,255);">
      <span style="color:#993399;">
       熵解码函数（Entropy Decoding）
      </span>
     </span>
    </h2>
    <span style="white-space:pre;">
    </span>
    熵解码函数（Entropy Decoding）读取码流数据并且进行CABAC或者CAVLC熵解码。CABAC解码函数是ff_h264_decode_mb_cabac()，CAVLC解码函数是ff_h264_decode_mb_cavlc()。熵解码函数中包含了很多的读取指数哥伦布编码数据的函数，例如get_ue_golomb_long()，get_ue_golomb()，get_se_golomb()，get_ue_golomb_31()等等。
    <br/>
    <span style="white-space:pre;">
    </span>
    在获取残差数据的时候需要进行CAVLC/CABAC解码。例如解码CAVLC的时候，会调用decode_residual()函数，而decode_residual()会调用get_vlc2()函数，get_vlc2()会调用OPEN_READER()，UPDATE_CACHE()，GET_VLC()，CLOSE_READER()几个函数读取CAVLC格式的数据。
    <br/>
    <span style="white-space:pre;">
    </span>
    此外，在获取运动矢量的时候，会调用pred_motion()以及类似的几个函数获取运动矢量相关的信息。
    <br/>
    <br/>
    <h2>
     <span style="color:#009900;">
      解码函数（Decode）
     </span>
    </h2>
    <span style="white-space:pre;">
    </span>
    解码函数（Decode）通过帧内预测、帧间预测、DCT反变换等方法解码压缩数据。解码函数是ff_h264_hl_decode_mb()。其中跟宏块类型的不同，会调用几个不同的函数，最常见的就是调用hl_decode_mb_simple_8()。
    <br/>
    <span style="white-space:pre;">
    </span>
    hl_decode_mb_simple_8()的定义是无法在源代码中直接找到的，这是因为它实际代码的函数名称是使用宏的方式写的（以后再具体分析）。hl_decode_mb_simple_8()的源代码实际上就是FUNC(hl_decode_mb)()函数的源代码。
    <br/>
    <span style="white-space:pre;">
    </span>
    FUNC(hl_decode_mb)()根据宏块类型的不同作不同的处理：如果宏块类型是INTRA，就会调用hl_decode_mb_predict_luma()进行帧内预测；如果宏块类型不是INTRA，就会调用FUNC(hl_motion_422)()或者FUNC(hl_motion_420)()进行四分之一像素运动补偿。
    <br/>
    <span style="white-space:pre;">
    </span>
    随后FUNC(hl_decode_mb)()会调用hl_decode_mb_idct_luma()等几个函数对数据进行DCT反变换工作。
    <br/>
    <br/>
    <h2>
     <span style="color:#ffcc00;">
      环路滤波函数（Loop Filter）
     </span>
    </h2>
    <span style="white-space:pre;">
    </span>
    环路滤波函数（Loop Filter）对解码后的数据进行滤波，去除方块效应。环路滤波函数是loop_filter()。其中调用了ff_h264_filter_mb()和ff_h264_filter_mb_fast()。ff_h264_filter_mb_fast()中又调用了h264_filter_mb_fast_internal()。而h264_filter_mb_fast_internal()中又调用了下面几个函数进行滤波：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     filter_mb_edgeh()：亮度水平滤波
     <br/>
     filter_mb_edgev()：亮度垂直滤波
     <br/>
     filter_mb_edgech()：色度水平滤波
     <p>
      filter_mb_edgecv()：色度垂直滤波
     </p>
    </blockquote>
    <p>
     <br/>
    </p>
    <h2>
     <span style="color:#3333ff;">
      汇编函数（Assembly）
     </span>
    </h2>
    <span style="white-space:pre;">
    </span>
    汇编函数（Assembly）是做过汇编优化的函数。为了提高效率，整个H.264解码器中（主要在解码部分和环路滤波部分）包含了大量的汇编函数。实际解码的过程中，FFmpeg会根据系统的特性调用相应的汇编函数（而不是C语言函数）以提高解码的效率。如果系统不支持汇编优化的话，FFmpeg才会调用C语言版本的函数。例如在帧内预测的时候，对于16x16亮度DC模式，有以下几个版本的函数：
    <br/>
    <blockquote style="margin:0 0 0 40px;border:none;padding:0px;">
     C语言版本的pred16x16_dc_8_c()
     <br/>
     NEON版本的ff_pred16x16_dc_neon()
     <br/>
     MMXEXT版本的ff_pred16x16_dc_8_mmxext()
     <br/>
     SSE2版本的ff_pred16x16_dc_8_sse2()
    </blockquote>
    <p>
     <br/>
    </p>
    <h2>
     附录
    </h2>
    <p>
     在网上找到一张图（出处不详），分析了FFmpeg的H.264解码器每个函数运行的耗时情况，比较有参考意义，在这里附上。
    </p>
    <p style="text-align:center;">
     <a href="http://img.my.csdn.net/uploads/201504/04/1428081882_2300.jpg">
      <img alt="" src="https://img-blog.csdn.net/20150404012417807"/>
     </a>
     <br/>
    </p>
    <p style="text-align:center;">
     <a href="https://my.csdn.net/leixiaohua1020/album/detail/1806349">
      单击查看更清晰的图片
     </a>
    </p>
    <p style="text-align:center;">
     <br/>
    </p>
    <p>
     从图中可以看出，熵解码、宏块解码、环路滤波耗时比例分别为：23.64%、51.85%、22.22%。
     <br/>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <br/>
    </p>
    至此FFmpeg的H.264解码器的结构就大致梳理完毕了。
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <strong>
     <span style="color:#660000;">
      雷霄骅
      <br/>
      leixiaohua1020@126.com
      <br/>
      http://blog.csdn.net/leixiaohua1020
     </span>
    </strong>
    <br/>
    <br/>
    <br/>
    <br/>
   </div>
  </div>
  <div style="display:none;" class="hide-article-box text-center csdn-tracking-statistics tracking-click" data-mod="popu_376">
   <a class="btn btn-red-hollow" id="btn-readmore">
    阅读更多
   </a>
  </div>
 </article>
 <div class="article-bar-bottom">
  <div class="article-copyright">
   版权声明：本文为博主原创文章，未经博主允许不得转载。			https://blog.csdn.net/leixiaohua1020/article/details/44864509
  </div>
  <div class="tags-box artic-tag-box">
   <span class="label">
    文章标签：
   </span>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=FFmpeg&amp;t=blog" target="_blank">
    FFmpeg
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=H.264&amp;t=blog" target="_blank">
    H.264
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=解码&amp;t=blog" target="_blank">
    解码
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=源代码&amp;t=blog" target="_blank">
    源代码
   </a>
  </div>
  <div class="tags-box">
   <span class="label">
    个人分类：
   </span>
   <a class="tag-link" href="https://blog.csdn.net/leixiaohua1020/article/category/1360795" target="_blank">
    FFMPEG
   </a>
  </div>
  <div class="tags-box">
   <span class="label">
    所属专栏：
   </span>
   <a class="tag-link" href="https://blog.csdn.net/column/details/ffmpeg-devel.html" target="_blank">
    FFmpeg
   </a>
  </div>
 </div>
 <!-- !empty($pre_next_article[0]) -->
</div>
<div class="recommend-box">
                            <div style="background: #fff; border: dashed 1px #666; padding-left: 1em; padding-top: 1em; padding-bottom: 1em;">
                                <span style="font-size: 0.8em; font-weight: bold;">
                                    此PDF由<a style="color:#0000ff" href="http://www.github.com/spygg"  target="_blank">spygg</a>生成,请尊重原作者版权!!!
                                    <br/>
                                    我的邮箱:liushidc@163.com
                                </span>
                                </div> 
                        </div>
                    </main>
      
                </div>

            <script>
                var recommendCount = 0;
                var articleTit = "";
                var articleId = "";
                var commentscount = 0;

                //1禁止评论，2正常
                var commentAuth = 1;
                //百度搜索
                var baiduKey = "";
                var needInsertBaidu = "";
            </script>
            <script src="https://csdnimg.cn/release/phoenix/template/js/detail-effe72036e.min.js"></script>
            </body>
        </html>