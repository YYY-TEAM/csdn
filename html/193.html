
            <!DOCTYPE html>
            <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>
 视音频编解码学习工程：FLV封装格式分析器 - CSDN博客
</title>

                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/detail-60a2c245da.min.css">
                <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/themes/skin3-template/skin3-template-88717cedf2.min.css">

                <script type="text/javascript">
                var username = "";
                </script>

                <script src="https://csdnimg.cn/public/common/libs/jquery/jquery-1.9.1.min.js" type="text/javascript"></script>

                <!-- 新版上报 -->
                <!-- 新版上报end -->
                <link rel="stylesheet" href="https://csdnimg.cn/public/sandalstrap/1.3/css/sandalstrap.min.css"> 
                </head>
                <body>    
        
                    <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/blog_code-c3a0c33d5c.css">
                    <div class="container clearfix pt0" id="mainBox">
        <main style="width: 100%;"><div class="blog-content-box">
 <div class="article-title-box" id="article_anchors_193">
  <span class="article-type type-1 float-left">
   原
  </span>
  <h1 class="title-article">
   视音频编解码学习工程：FLV封装格式分析器
  </h1>
 </div>
 <div class="article-info-box">
  <div class="article-bar-top d-flex">
   <span class="time">
    2014年01月12日 00:01:19
   </span>
   <div ">
    <span class="read-count">
     阅读数：38493
    </span>
   </div>
  </div>
 </div>
 <article>
  <div class="article_content clearfix csdn-tracking-statistics" data-dsm="post" data-mod="popu_307" data-pid="blog" id="article_content">
   <link href="https://csdnimg.cn/release/phoenix/template/css/htmledit_views-0a60691e80.css" rel="stylesheet"/>
   <div class="htmledit_views">
    <p>
     =====================================================
    </p>
    <p>
     视音频编解码学习工程系列文章列表：
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/17933821" target="_blank">
      视音频编解码学习工程：H.264分析器
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/18155549" target="_blank">
      视音频编解码学习工程：AAC格式分析器
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/17934487" target="_blank">
      视音频编解码学习工程：FLV封装格式分析器
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/17973587" target="_blank">
      视音频编解码学习工程：TS封装格式分析器
     </a>
    </p>
    <p>
     <a href="http://blog.csdn.net/leixiaohua1020/article/details/18280253" target="_blank">
      视音频编解码学习工程：JPEG分析器
     </a>
     <br/>
    </p>
    <p>
     =====================================================
    </p>
    <p>
     本文介绍一个自己的开源小项目：FLV封装格式分析器。FLV全称是Flash Video，是互联网上使用极为广泛的视频封装格式。像Youtube，优酷这类视频网站，都使用FLV封装视频。我这个项目规模不大，主要可以用来学习FLV封装格式结构。此外它还支持分离FLV中的视频流和音频流。使用VC 2010的MFC开发完成。在对FLV进行视音频分离的过程中，用到了一个Github开源小工程：flvparse。在此插一句：我发现Github上优秀的东西真的还是挺多的，许多零散的小工程，效果都很不错。这个flvparse做的就不错。
    </p>
    <p>
     软件的exe以及源代码已经上传到了SourceForge上。和之前的H.264码流分析器一样，增加了一个英文界面，紧跟国际潮流~
    </p>
    <p>
     项目地址：
     <a href="https://sourceforge.net/projects/flvformatanalysis/" target="_blank">
      https://sourceforge.net/projects/flvformatanalysis/
     </a>
    </p>
    <p>
     CSDN下载地址（程序+源代码）：
     <a href="http://download.csdn.net/detail/leixiaohua1020/6838805" target="_blank">
      http://download.csdn.net/detail/leixiaohua1020/6838805
     </a>
    </p>
    <p style="text-align: center;">
     <img alt="" src="http://img.blog.csdn.net/20140708232705606"/>
     <br/>
    </p>
    <p>
    </p>
    <p>
     更新记录==============================
    </p>
    <p>
     1.1版（2014.7.8）
    </p>
    <p>
     * 更换了界面
    </p>
    <p>
     * 原工程支持Unicode编码
    </p>
    <p>
     * 支持中英文切换
    </p>
    <p>
     CSDN源代码：
     <a href="http://download.csdn.net/detail/leixiaohua1020/7767613" target="_blank">
      http://download.csdn.net/detail/leixiaohua1020/7767613
     </a>
    </p>
    <div>
     PUDN源代码：
     <a href="http://www.pudn.com/downloads644/sourcecode/multimedia/detail2605189.html" target="_blank">
      http://www.pudn.com/downloads644/sourcecode/multimedia/detail2605189.html
     </a>
    </div>
    <p>
     <br/>
    </p>
    <p>
     新版（2016.1.1）
    </p>
    <p>
     * 精简了代码，使之更通俗易懂
    </p>
    <p>
     * 修改了少量界面UI
    </p>
    <p>
     * 修正了少量解析错误
    </p>
    <p>
     * 添加了对TagData首字节的解析
    </p>
    <p>
     已经更新至SourceForge上
    </p>
    <p>
     <br/>
    </p>
    <p>
     <span style="font-size: 18px;">
      <strong>
       软件使用介绍
      </strong>
     </span>
    </p>
    <p>
     软件的使用相当简单。软件运行后，首先打开一个FLV文件。单击“开始”，可以解析出一系列Tag，列表显示在软件右侧。不同种类的Tag被标记成了不同的颜色。列表中包含了每个Tag的类型、大小、时间戳、StreamID、TagData首字节。软件的左侧，显示了FLV文件头信息。
    </p>
    <p style="text-align:center">
     <img alt="" src="http://img.blog.csdn.net/20160118102636175"/>
     <br/>
    </p>
    <p>
     此外软件做了一个英文界面，如下所示。
    </p>
    <p style="text-align:center">
     <img alt="" src="http://img.blog.csdn.net/20160118102649368"/>
     <br/>
    </p>
    <p>
     <span style="font-family:FangSong_GB2312;">
      注：如果勾选上“输出视频”，“输出音频”的话，可以输出分离后的视频流和音频流。在这里要注意的是音频支持MP3格式，AAC格式貌似有点问题。
     </span>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <span style="font-size: 18px;">
      <strong>
       软件源代码简析
      </strong>
     </span>
    </p>
    <p>
     源代码方面和普通的MFC程序差不太多，懂得MFC的人应该很快就能看懂。唯一比较特殊的地方，就在于对开源项目flvparse进行了一些改动，在此就不细说了。注释方面还是很充分的。
    </p>
    <p>
     <br/>
    </p>
    <h2>
     FLV封装原理
    </h2>
    <div>
     FLV格式的封装原理，贴上来辅助学习之用。
    </div>
    <div>
     <br/>
    </div>
    <div>
     <br/>
    </div>
    <div>
     <p>
      FLV（Flash Video）是Adobe公司设计开发的一种流行的流媒体格式，由于其视频文件体积轻巧、封装简单等特点，使其很适合在互联网上进行应用。此外，FLV可以使用Flash Player进行播放，而Flash Player插件已经安装在全世界绝大部分浏览器上，这使得通过网页播放FLV视频十分容易。目前主流的视频网站如优酷网，土豆网，乐视网等网站无一例外地使用了FLV格式。FLV封装格式的文件后缀通常为“.flv”。
     </p>
     <p>
      总体上看，FLV包括文件头（File Header）和文件体（File Body）两部分，其中文件体由一系列的Tag组成。因此一个FLV文件是如图1结构。
     </p>
     <p style="text-align: center;">
      <img alt="" src="http://img.blog.csdn.net/20140812104854882"/>
      <br/>
     </p>
     <p align="center">
      图1.文件结构（简图）
     </p>
     <p>
      其中，每个Tag前面还包含了Previous Tag Size字段，表示前面一个Tag的大小。Tag的类型可以是视频、音频和Script，每个Tag只能包含以上三种类型的数据中的一种。图2展示了FLV文件的详细结构。
     </p>
     <p style="text-align: center;">
      <img alt="" src="http://img.blog.csdn.net/20150402014048465"/>
      <br/>
     </p>
     <p align="center">
      图2.FLV文件结构（详图）
     </p>
     <p>
      下面详细介绍一下三种Tag的Tag Data部分的结构。
     </p>
     <p>
      (a)Audio Tag Data结构（音频Tag）
     </p>
     <p>
      音频Tag开始的第1个字节包含了音频数据的参数信息，从第2个字节开始为音频流数据。结构如图3所示。
     </p>
     <p style="text-align: center;">
      <img alt="" src="http://img.blog.csdn.net/20140812104812062"/>
      <br/>
     </p>
     <p align="center">
      <span style="text-align: -webkit-center;">
       图3.
      </span>
      Audio Tag Data结构
     </p>
     <p>
      第1个字节的前4位的数值表示了音频编码类型。如表1所示。
     </p>
     <p align="center">
      表1.音频编码类型
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           0
          </p>
         </td>
         <td valign="top">
          <p>
           Linear PCM，platform endian
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           ADPCM
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           2
          </p>
         </td>
         <td valign="top">
          <p>
           MP3
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           3
          </p>
         </td>
         <td valign="top">
          <p>
           Linear PCM，little endian
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           4
          </p>
         </td>
         <td valign="top">
          <p>
           Nellymoser 16-kHz mono
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           5
          </p>
         </td>
         <td valign="top">
          <p>
           Nellymoser 8-kHz mono
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           6
          </p>
         </td>
         <td valign="top">
          <p>
           Nellymoser
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           7
          </p>
         </td>
         <td valign="top">
          <p>
           G.711 A-law logarithmic PCM
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           8
          </p>
         </td>
         <td valign="top">
          <p>
           G.711 mu-law logarithmic PCM
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           9
          </p>
         </td>
         <td valign="top">
          <p>
           reserved
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           10
          </p>
         </td>
         <td valign="top">
          <p>
           AAC
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           14
          </p>
         </td>
         <td valign="top">
          <p>
           MP3 8-Khz
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           15
          </p>
         </td>
         <td valign="top">
          <p>
           Device-specific sound
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      第1个字节的第5-6位的数值表示音频采样率。如表2所示。
     </p>
     <p align="center">
      表2.音频采样率
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           0
          </p>
         </td>
         <td valign="top">
          <p>
           5.5kHz
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           11KHz
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           2
          </p>
         </td>
         <td valign="top">
          <p>
           22 kHz
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           3
          </p>
         </td>
         <td valign="top">
          <p>
           44 kHz
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      PS：从上表可以发现，FLV封装格式并不支持48KHz的采样率。
     </p>
     <p>
      第1个字节的第7位表示音频采样精度。如表3所示。
     </p>
     <p align="center">
      <span style="text-align: -webkit-center;">
       表3.
      </span>
      音频采样精度
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           0
          </p>
         </td>
         <td valign="top">
          <p>
           8bits
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           16bits
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      第1个字节的第8位表示音频类型。
     </p>
     <p align="center">
      <span style="text-align: -webkit-center;">
       表4.
      </span>
      音频类型
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           0
          </p>
         </td>
         <td valign="top">
          <p>
           sndMono
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           sndStereo
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      (b)Video Tag Data结构（视频Tag）
     </p>
     <p>
      视频Tag也用开始的第1个字节包含视频数据的参数信息，从第2个字节为视频流数据。结构如图4所示。
     </p>
     <p style="text-align: center;">
      <img alt="" src="http://img.blog.csdn.net/20140812105200522"/>
      <br/>
     </p>
     <p align="center">
      图4.Video Tag Data结构
     </p>
     <p>
      第1个字节的前4位的数值表示帧类型。如表5所示。
     </p>
     <p align="center">
      表5.帧类型
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           keyframe （for AVC，a seekable frame）
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           2
          </p>
         </td>
         <td valign="top">
          <p>
           inter frame （for AVC，a nonseekable frame）
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           3
          </p>
         </td>
         <td valign="top">
          <p>
           disposable inter frame （H.263  only）
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           4
          </p>
         </td>
         <td valign="top">
          <p>
           generated keyframe （reserved  for server use）
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           5
          </p>
         </td>
         <td valign="top">
          <p>
           video info/command frame
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      第1个字节的后4位的数值表示视频编码类型。如表6所示。
     </p>
     <p align="center">
      表6.视频编码类型
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           1
          </p>
         </td>
         <td valign="top">
          <p>
           JPEG （currently unused）
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           2
          </p>
         </td>
         <td valign="top">
          <p>
           Sorenson H.263
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           3
          </p>
         </td>
         <td valign="top">
          <p>
           Screen video
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           4
          </p>
         </td>
         <td valign="top">
          <p>
           On2 VP6
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           5
          </p>
         </td>
         <td valign="top">
          <p>
           On2 VP6 with alpha channel
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           6
          </p>
         </td>
         <td valign="top">
          <p>
           Screen video version 2
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           7
          </p>
         </td>
         <td valign="top">
          <p>
           AVC
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
      (c)Script Tag Data结构（控制帧）
     </p>
     <p>
      该类型Tag又通常被称为Metadata Tag，会放一些关于FLV视频和音频的元数据信息如：duration、width、height等。通常该类型Tag会跟在File Header后面作为第一个Tag出现，而且只有一个。结构如图5所示。
     </p>
     <p style="text-align: center;">
      <img alt="" src="http://img.blog.csdn.net/20140812105312610"/>
      <br/>
     </p>
     <p align="center">
      图5.Script Tag Data结构
     </p>
     <p>
      第一个AMF包：
     </p>
     <p>
      第1个字节表示AMF包类型，一般总是0x02，表示字符串。第2-3个字节为UI16类型值，标识字符串的长度，一般总是0x000A（“onMetaData”长度）。后面字节为具体的字符串，一般总为“onMetaData”（6F,6E,4D,65,74,61,44,61,74,61）。
     </p>
     <p>
      第二个AMF包：
     </p>
     <p>
      第1个字节表示AMF包类型，一般总是0x08，表示数组。第2-5个字节为UI32类型值，表示数组元素的个数。后面即为各数组元素的封装，数组元素为元素名称和值组成的对。常见的数组元素如表7所示。
     </p>
     <p align="center">
      表7.常见MetaData
     </p>
     <div align="center">
      <table border="1" cellpadding="0" cellspacing="0" width="400">
       <tbody>
        <tr>
         <td valign="top" width="25%">
          <p>
           值
          </p>
         </td>
         <td valign="top" width="75%">
          <p>
           含义
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           duration
          </p>
         </td>
         <td valign="top">
          <p>
           时长
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           width
          </p>
         </td>
         <td valign="top">
          <p>
           视频宽度
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           height
          </p>
         </td>
         <td valign="top">
          <p>
           视频高度
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           videodatarate
          </p>
         </td>
         <td valign="top">
          <p>
           视频码率
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           framerate
          </p>
         </td>
         <td valign="top">
          <p>
           视频帧率
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           videocodecid
          </p>
         </td>
         <td valign="top">
          <p>
           视频编码方式
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           audiosamplerate
          </p>
         </td>
         <td valign="top">
          <p>
           音频采样率
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           audiosamplesize
          </p>
         </td>
         <td valign="top">
          <p>
           音频采样精度
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           stereo
          </p>
         </td>
         <td valign="top">
          <p>
           是否为立体声
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           audiocodecid
          </p>
         </td>
         <td valign="top">
          <p>
           音频编码方式
          </p>
         </td>
        </tr>
        <tr>
         <td valign="top">
          <p>
           filesize
          </p>
         </td>
         <td valign="top">
          <p>
           文件大小
          </p>
         </td>
        </tr>
       </tbody>
      </table>
     </div>
     <p>
     </p>
     <br/>
    </div>
    <div>
     <br/>
    </div>
    <div>
     <br/>
    </div>
    <div>
     <br/>
    </div>
   </div>
  </div>
  <div style="display:none;" class="hide-article-box text-center csdn-tracking-statistics tracking-click" data-mod="popu_376">
   <a class="btn btn-red-hollow" id="btn-readmore">
    阅读更多
   </a>
  </div>
 </article>
 <div class="article-bar-bottom">
  <div class="article-copyright">
   版权声明：本文为博主原创文章，未经博主允许不得转载。			https://blog.csdn.net/leixiaohua1020/article/details/17934487
  </div>
  <div class="tags-box artic-tag-box">
   <span class="label">
    文章标签：
   </span>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=flv&amp;t=blog" target="_blank">
    flv
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=封装格式&amp;t=blog" target="_blank">
    封装格式
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=解析&amp;t=blog" target="_blank">
    解析
   </a>
   <a class="tag-link" href="http://so.csdn.net/so/search/s.do?q=开源项目&amp;t=blog" target="_blank">
    开源项目
   </a>
  </div>
  <div class="tags-box">
   <span class="label">
    个人分类：
   </span>
   <a class="tag-link" href="https://blog.csdn.net/leixiaohua1020/article/category/1843731" target="_blank">
    我的开源项目
   </a>
  </div>
 </div>
 <!-- !empty($pre_next_article[0]) -->
</div>
<div class="recommend-box">
                            <div style="background: #fff; border: dashed 1px #666; padding-left: 1em; padding-top: 1em; padding-bottom: 1em;">
                                <span style="font-size: 0.8em; font-weight: bold;">
                                    此PDF由<a style="color:#0000ff" href="http://www.github.com/spygg"  target="_blank">spygg</a>生成,请尊重原作者版权!!!
                                    <br/>
                                    我的邮箱:liushidc@163.com
                                </span>
                                </div> 
                        </div>
                    </main>
      
                </div>

            <script>
                var recommendCount = 0;
                var articleTit = "";
                var articleId = "";
                var commentscount = 0;

                //1禁止评论，2正常
                var commentAuth = 1;
                //百度搜索
                var baiduKey = "";
                var needInsertBaidu = "";
            </script>
            <script src="https://csdnimg.cn/release/phoenix/template/js/detail-effe72036e.min.js"></script>
            </body>
        </html>